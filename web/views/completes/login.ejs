<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<main class="content">
    <div class="login-container">
        <h1>Iniciar Sesión</h1>
        <p>Introduce tus credenciales para entrenar</p>

        <div id="mensaje" style="text-align: center; margin: 20px 0; font-weight: bold;"></div>

        <form id="login-form">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" required placeholder="tu@email.com">
            </div>

            <div class="form-group">
                <label for="password">Contraseña</label>
                <input type="password" id="password" name="password" required>
            </div>

            <button type="submit" class="btn-primary">Entrar</button>
        </form>

        <p style="text-align:center; margin-top:30px;">
            ¿No tienes cuenta? <a href="/registro" style="color:#1e90ff; text-decoration:underline;">Regístrate aquí</a>
        </p>
    </div>
</main>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyA0w8YQWXLYoblPD2Ma1Ly0_tHN7c_Qu04", 
    authDomain: "toji-gym.firebaseapp.com",
    projectId: "toji-gym",
    storageBucket: "toji-gym.firebasestorage.app",
    messagingSenderId: "713518995736",
    appId: "1:713518995736:web:8777e9284e86782d21e66d"
};

firebase.initializeApp(firebaseConfig);

document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const mensaje = document.getElementById('mensaje');
    mensaje.textContent = '';
    mensaje.style.color = '';

    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    if (!email || !password) {
        mensaje.style.color = 'red';
        mensaje.textContent = 'Completa email y contraseña';
        return;
    }

    mensaje.textContent = 'Iniciando sesión...';
    mensaje.style.color = '#666';

    try {
        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
        const idToken = await userCredential.user.getIdToken();

        const response = await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ idToken })
        });

        const result = await response.json();

        if (response.ok && result.success) {
            mensaje.style.color = 'green';
            mensaje.textContent = '¡Sesión iniciada! Redirigiendo...';
            setTimeout(() => {
                window.location.href = result.redirect || '/ejercicios';
            }, 1000);
        } else {
            mensaje.style.color = 'red';
            mensaje.textContent = result.error || 'Error al iniciar sesión';
        }
    } catch (error) {
        console.error('Error Firebase:', error);
        mensaje.style.color = 'red';
        mensaje.textContent = 'Error al iniciar sesión: ' + error.message;
    }
});
</script>

<%- include('../partials/footer') %>