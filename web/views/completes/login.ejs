<%- include('../partials/header') %>

<main class="login-container">
    <div class="login-card">
        <div class="nav-logo">
            <h2>TOJI</h2>
        </div>
        
        <h1 id="auth-title">Iniciar Sesión</h1>
        <p class="workout-meta" id="auth-subtitle">Introduce tus credenciales para entrenar</p>

        <form id="auth-form" style="margin-top: 20px;">
            <div class="form-group">
                <input type="email" id="email" placeholder="Correo electrónico" required>
            </div>
            <div class="form-group">
                <input type="password" id="password" placeholder="Contraseña" required>
            </div>
            
            <button type="submit" id="submit-btn" class="btn-login" style="width: 100%; border: none; cursor: pointer; margin-top: 10px;">
                Entrar
            </button>
        </form>

        <div style="margin-top: 20px;">
            <p class="workout-meta">
                <span id="toggle-text">¿No tienes cuenta?</span> 
                <a href="#" id="toggle-auth" style="color: var(--accent-color); text-decoration: none; font-weight: bold;">Regístrate</a>
            </p>
        </div>
        <div id="message" style="margin-top: 15px; font-size: 0.9rem; min-height: 20px;"></div>
    </div>
</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA0w8YQWXLYoblPD2Ma1Ly0_tHN7c_Qu04",
        authDomain: "toji-gym.firebaseapp.com",
        projectId: "toji-gym",
        storageBucket: "toji-gym.firebasestorage.app",
        messagingSenderId: "713518995736",
        appId: "1:713518995736:web:8777e9284e86782d21e66d",
        measurementId: "G-V7JQQ0PVR5"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const authForm = document.getElementById('auth-form');
    const toggleBtn = document.getElementById('toggle-auth');
    const authTitle = document.getElementById('auth-title');
    const messageDiv = document.getElementById('message');
    const submitBtn = document.getElementById('submit-btn');
    const toggleText = document.getElementById('toggle-text');
    const authSubtitle = document.getElementById('auth-subtitle');

    toggleBtn.addEventListener('click', (e) => {
        e.preventDefault();
        messageDiv.innerText = '';
        if (authTitle.innerText === 'Iniciar Sesión') {
            authTitle.innerText = 'Crear Cuenta';
            authSubtitle.innerText = 'Únete a la comunidad Toji';
            toggleText.innerText = '¿Ya tienes cuenta?';
            toggleBtn.innerText = 'Inicia Sesión';
            submitBtn.innerText = 'Registrarse';
        } else {
            authTitle.innerText = 'Iniciar Sesión';
            authSubtitle.innerText = 'Introduce tus credenciales para entrenar';
            toggleText.innerText = '¿No tienes cuenta?';
            toggleBtn.innerText = 'Regístrate';
            submitBtn.innerText = 'Entrar';
        }
    });

    authForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        messageDiv.innerText = 'Procesando...';
        messageDiv.style.color = 'var(--text-secondary)'; 
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const isLogin = authTitle.innerText === 'Iniciar Sesión';

        try {
            let userCredential;

            if (isLogin) {
                userCredential = await signInWithEmailAndPassword(auth, email, password);
            } else {
                userCredential = await createUserWithEmailAndPassword(auth, email, password);
            }

            const idToken = await userCredential.user.getIdToken();

            const response = await fetch('/api/auth/session-login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken })
            });

            if (response.ok) {
                messageDiv.style.color = '#2ecc71'; 
                messageDiv.innerText = '¡Éxito! Redirigiendo...';
                setTimeout(() => {
                    window.location.assign('/'); 
                }, 800);
            } else {
                const errorData = await response.json();
                messageDiv.style.color = '#e74c3c'; 
                messageDiv.innerText = 'Error del servidor: ' + (errorData.message || 'No autorizado');
            }

        } catch (error) {
            console.error(error);
            messageDiv.style.color = '#e74c3c';

            let msg = "Error desconocido.";
            if (error.code === 'auth/invalid-credential') msg = "Correo o contraseña incorrectos.";
            if (error.code === 'auth/email-already-in-use') msg = "Este correo ya está registrado.";
            if (error.code === 'auth/weak-password') msg = "La contraseña debe tener al menos 6 caracteres.";
            if (error.code === 'auth/invalid-email') msg = "El formato del correo no es válido.";
            
            messageDiv.innerText = msg;
        }
    });
</script>

<%- include('../partials/footer') %>