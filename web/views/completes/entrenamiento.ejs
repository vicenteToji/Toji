<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<main class="content">
    <div class="header-section">
        <h1>Entrenamiento: <%= rutina.nombre %></h1>
        <button id="terminar-entreno" class="btn-primary">Terminar Entrenamiento</button>
    </div>

    <div class="grid-ejercicios">
        <% rutina.ejercicios.forEach((ejercicio, ejIndex) => { %>
            <div class="card-ejercicio" data-ejercicio-id="<%= ejercicio.id %>">
                <h3><%= ejercicio.nombre %></h3>
                <span class="tag"><%= ejercicio.grupo_muscular || 'Sin grupo' %></span>
                <p><%= ejercicio.descripcion || 'Sin descripción' %></p>
                <small>Equipo: <%= ejercicio.equipo || 'Ninguno' %></small>

                <div style="margin-top: 20px;">
                    <p><strong>Notas:</strong></p>
                    <textarea class="notas-input" data-ej-index="<%= ejIndex %>" rows="3" placeholder="Agregar notas..."></textarea>
                </div>

                <div style="margin-top: 20px;">
                    <p><strong>Descanso:</strong> APAGADO</p>
                </div>

                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>SERIE</th>
                            <th>ANTERIOR</th>
                            <th>KG</th>
                            <th>REPS</th>
                            <th>✓</th>
                        </tr>
                    </thead>
                    <tbody class="series-body" data-ej-index="<%= ejIndex %>">
                        <tr>
                            <td>1</td>
                            <td>-</td>
                            <td><input type="number" class="kg-input" placeholder="kg" step="0.5"></td>
                            <td><input type="number" class="reps-input" placeholder="reps"></td>
                            <td><input type="checkbox"></td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>-</td>
                            <td><input type="number" class="kg-input" placeholder="kg" step="0.5"></td>
                            <td><input type="number" class="reps-input" placeholder="reps"></td>
                            <td><input type="checkbox"></td>
                        </tr>
                    </tbody>
                </table>

                <button class="add-serie" data-ej-index="<%= ejIndex %>">+ Agregar Serie</button>
            </div>
        <% }) %>
    </div>
</main>

<script>
let ejerciciosData = [];

<% rutina.ejercicios.forEach((ej, index) => { %>
ejerciciosData.push({
    id: <%= ej.id %>,
    nombre: '<%= ej.nombre %>',
    series: []
});
<% }) %>

document.querySelectorAll('.add-serie').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const ejIndex = parseInt(e.target.dataset.ejIndex);
        const tbody = document.querySelector(`.series-body[data-ej-index="${ejIndex}"]`);
        const serieNum = tbody.children.length + 1;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${serieNum}</td>
            <td>-</td>
            <td><input type="number" class="kg-input" placeholder="kg" step="0.5"></td>
            <td><input type="number" class="reps-input" placeholder="reps"></td>
            <td><input type="checkbox"></td>
        `;

        tbody.appendChild(tr);
    });
});

document.getElementById('terminar-entreno').addEventListener('click', async () => {
    if (!confirm('¿Terminar el entrenamiento y guardar?')) return;

    const entrenamientoData = {
        rutina_id: <%= rutina.id %>,
        notas: '', 
        ejercicios: ejerciciosData.map((ej, ejIndex) => {
            const notasInput = document.querySelector(`.notas-input[data-ej-index="${ejIndex}"]`);
            const seriesRows = document.querySelectorAll(`.series-body[data-ej-index="${ejIndex}"] tr`);

            const series = [];
            seriesRows.forEach(row => {
                const kg = parseFloat(row.querySelector('.kg-input').value) || 0;
                const reps = parseInt(row.querySelector('.reps-input').value) || 0;
                if (kg > 0 || reps > 0) {
                    series.push({ peso: kg, reps });
                }
            });

            return {
                id: ej.id,
                notas: notasInput ? notasInput.value : '',
                series
            };
        }).filter(ej => ej.series.length > 0)
    };

    try {
        const response = await fetch('/api/entrenamientos/guardar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(entrenamientoData)
        });

        const result = await response.json();

        if (response.ok) {
            alert('Entrenamiento guardado con éxito');
            window.location.href = '/';
        } else {
            alert(result.error || 'Error al guardar');
        }
    } catch (err) {
        alert('Error de conexión');
    }
});
</script>

<%- include('../partials/footer') %>