<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<main class="content">
  <div class="form-container">
    <h1 class="page-title">Editar Rutina</h1>

    <form id="form-editar-rutina" class="exercise-form">
      <input type="hidden" id="rutina-id" value="<%= rutina.id %>">

      <div class="form-group">
        <label for="nombre">Nombre de la rutina</label>
        <input 
          type="text" 
          id="nombre" 
          name="nombre" 
          value="<%= rutina.nombre %>" 
          placeholder="Ej: Push Día A" 
          required 
        />
      </div>

      <div class="form-group">
        <label for="descripcion">Descripción <span class="optional">(Opcional)</span></label>
        <textarea 
          id="descripcion" 
          name="descripcion" 
          rows="4" 
          placeholder="Describe tu rutina..."
        ><%= rutina.descripcion || '' %></textarea>
      </div>

      <div class="form-group">
        <label>Añade o quita ejercicios de tu biblioteca</label>
        <div id="lista-ejercicios-rutina" class="ejercicios-checkbox-list">
          <p class="loading-text">Cargando tus ejercicios...</p>
        </div>
      </div>

      <div class="button-group">
        <button type="submit" class="btn-primary-large">
          Guardar Cambios
        </button>
        <a href="/rutinas" class="btn-secondary-large">
          Cancelar
        </a>
      </div>
    </form>

    <div id="mensaje-feedback"></div>
  </div>
</main>

<script>
const API_EJERCICIOS = '/api/ejercicios';
const API_RUTINAS = '/api/rutinas';
const rutinaId = document.getElementById('rutina-id').value;

const ejerciciosActuales = new Set();
<% rutina.ejercicios.forEach(ej => { %>
  ejerciciosActuales.add(<%= ej.id %>);
<% }) %>

async function cargarEjerciciosParaEditar() {
  const contenedor = document.getElementById('lista-ejercicios-rutina');

  try {
    const res = await fetch(API_EJERCICIOS);
    if (!res.ok) throw new Error('Error al cargar ejercicios');
    const ejercicios = await res.json();

    contenedor.innerHTML = '';

    if (ejercicios.length === 0) {
      contenedor.innerHTML = '<p class="empty-message">No tienes ejercicios aún. <a href="/ejercicios/nuevo">Añade uno aquí</a></p>';
      return;
    }

    ejercicios.forEach(ej => {
      const checked = ejerciciosActuales.has(ej.id) ? 'checked' : '';

      const div = document.createElement('div');
      div.className = 'checkbox-item';
      div.innerHTML = `
        <label class="checkbox-label">
          <input type="checkbox" value="${ej.id}" ${checked}>
          <span class="checkmark"></span>
          <div class="ejercicio-info">
            <strong>${ej.nombre}</strong>
            <span class="grupo">${ej.grupo_muscular || 'Sin grupo'}</span>
            <small>${ej.descripcion || 'Sin descripción'}${ej.equipo ? ' · Equipo: ' + ej.equipo : ''}</small>
          </div>
        </label>
      `;
      contenedor.appendChild(div);
    });
  } catch (err) {
    console.error('Error al cargar ejercicios:', err);
    contenedor.innerHTML = '<p class="error-text">Error al cargar ejercicios. Recarga la página.</p>';
  }
}

document.getElementById('form-editar-rutina').addEventListener('submit', async (e) => {
  e.preventDefault();

  let mensaje = document.getElementById('mensaje-feedback');
  if (!mensaje) {
    mensaje = document.createElement('p');
    mensaje.id = 'mensaje-feedback';
    document.querySelector('.form-container').appendChild(mensaje);
  }

  mensaje.textContent = 'Guardando cambios...';
  mensaje.style.color = '#3498db';

  const nombre = document.getElementById('nombre').value.trim();
  const descripcion = document.getElementById('descripcion').value.trim() || null;
  const checkboxes = document.querySelectorAll('#lista-ejercicios-rutina input[type="checkbox"]:checked');
  const ejercicios = Array.from(checkboxes).map(cb => parseInt(cb.value));

  if (!nombre) {
    mensaje.style.color = '#e74c3c';
    mensaje.textContent = 'El nombre de la rutina es obligatorio.';
    return;
  }

  if (ejercicios.length === 0) {
    mensaje.style.color = '#e74c3c';
    mensaje.textContent = 'Selecciona al menos un ejercicio.';
    return;
  }

  try {
    const response = await fetch(`${API_RUTINAS}/${rutinaId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nombre, descripcion, ejercicios })
    });

    const result = await response.json();

    if (response.ok) {
      mensaje.style.color = '#2ecc71';
      mensaje.textContent = '¡Rutina actualizada con éxito! Redirigiendo...';
      setTimeout(() => {
        window.location.href = '/rutinas';
      }, 1500);
    } else {
      mensaje.style.color = '#e74c3c';
      mensaje.textContent = result.error || 'Error al actualizar la rutina.';
    }
  } catch (err) {
    console.error('Error:', err);
    mensaje.style.color = '#e74c3c';
    mensaje.textContent = 'Error de conexión. Intenta de nuevo.';
  }
});

cargarEjerciciosParaEditar();
</script>

<%- include('../partials/footer') %>