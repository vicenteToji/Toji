<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<main class="content">
  <div class="form-container">
    <h1 class="page-title">Registrarse</h1>
    <p class="subtitle">Crea una cuenta para empezar a entrenar</p>

    <div id="mensaje-feedback"></div>

    <form id="registro-form" class="exercise-form">
      <div class="form-group">
        <label for="email">Email</label>
        <input 
          type="email" 
          id="email" 
          name="email" 
          placeholder="tu@email.com" 
          required 
        />
      </div>

      <div class="form-group">
        <label for="password">Contraseña</label>
        <input 
          type="password" 
          id="password" 
          name="password" 
          placeholder="••••••••" 
          required 
        />
      </div>

      <button type="submit" class="btn-primary-large">
        Registrarse
      </button>
    </form>

    <p class="register-link">
      ¿Ya tienes cuenta? 
      <a href="/login">Inicia sesión aquí</a>
    </p>
  </div>
</main>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA0w8YQWXLYoblPD2Ma1Ly0_tHN7c_Qu04",
  authDomain: "toji-gym.firebaseapp.com",
  projectId: "toji-gym",
  storageBucket: "toji-gym.firebasestorage.app",
  messagingSenderId: "713518995736",
  appId: "1:713518995736:web:8777e9284e86782d21e66d"
};

firebase.initializeApp(firebaseConfig);

document.getElementById('registro-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  let mensaje = document.getElementById('mensaje-feedback');
  if (!mensaje) {
    mensaje = document.createElement('p');
    mensaje.id = 'mensaje-feedback';
    document.querySelector('.form-container').insertBefore(mensaje, document.querySelector('.exercise-form'));
  }

  mensaje.textContent = 'Creando cuenta...';
  mensaje.style.color = '#3498db';

  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;

  if (!email || !password) {
    mensaje.style.color = '#e74c3c';
    mensaje.textContent = 'Completa email y contraseña';
    return;
  }

  if (password.length < 6) {
    mensaje.style.color = '#e74c3c';
    mensaje.textContent = 'La contraseña debe tener al menos 6 caracteres';
    return;
  }

  try {
    const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
    const idToken = await userCredential.user.getIdToken();

    const response = await fetch('/registro', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ idToken })
    });

    const result = await response.json();

    if (response.ok && result.success) {
      mensaje.style.color = '#2ecc71';
      mensaje.textContent = '¡Cuenta creada con éxito! Redirigiendo al login...';
      setTimeout(() => {
        window.location.href = '/login';
      }, 1500);
    } else {
      mensaje.style.color = '#e74c3c';
      mensaje.textContent = result.error || 'Error al crear la cuenta';
    }
  } catch (error) {
    console.error('Error Firebase:', error);
    let errorMsg = 'Error al crear la cuenta: ';
    if (error.code === 'auth/email-already-in-use') {
      errorMsg += 'Este email ya está en uso';
    } else if (error.code === 'auth/weak-password') {
      errorMsg += 'Contraseña demasiado débil';
    } else {
      errorMsg += error.message;
    }
    mensaje.style.color = '#e74c3c';
    mensaje.textContent = errorMsg;
  }
});
</script>

<%- include('../partials/footer') %>