<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<main class="content">
  <div class="header-section">
    <h1 class="page-title">Biblioteca de Ejercicios</h1>
    <p class="subtitle">Consulta tus técnicas de entrenamiento de Toji.</p>
    <a href="/ejercicios/nuevo" class="btn-primary-large">+ Nuevo Ejercicio</a>
  </div>

  <div id="lista-ejercicios" class="grid-ejercicios">
    <p class="loading-text">Cargando tus ejercicios...</p>
  </div>

  <div id="mensaje-feedback-global"></div>
</main>

<script>
const API_URL = '/api/ejercicios';

document.addEventListener('DOMContentLoaded', () => {
  cargarEjercicios();
});

async function cargarEjercicios() {
  const contenedor = document.getElementById('lista-ejercicios');

  try {
    const response = await fetch(API_URL);

    if (!response.ok) {
      if (response.status === 401) {
        contenedor.innerHTML = '<p class="error-text">Sesión expirada. <a href="/login">Inicia sesión de nuevo</a>.</p>';
        return;
      }
      throw new Error(`Error HTTP: ${response.status}`);
    }

    const ejercicios = await response.json();

    contenedor.innerHTML = '';

    if (ejercicios.length === 0) {
      contenedor.innerHTML = `
        <div class="empty-message">
          <p>Aún no tienes ejercicios guardados.</p>
          <a href="/ejercicios/nuevo" class="btn-primary-large">Añade tu primera técnica</a>
        </div>`;
      return;
    }

    ejercicios.forEach(ejercicio => {
      const card = document.createElement('div');
      card.className = 'card-ejercicio';
      card.setAttribute('data-id', ejercicio.id);

      const grupoTag = ejercicio.grupo_muscular 
        ? `<span class="tag">${ejercicio.grupo_muscular}</span>` 
        : '<span class="tag">Sin grupo</span>';

      card.innerHTML = `
        <h3>${ejercicio.nombre}</h3>
        ${grupoTag}
        <p class="descripcion">${ejercicio.descripcion || 'Sin descripción'}</p>
        <small>Equipo: ${ejercicio.equipo || 'Ninguno'}</small>
        <div class="card-actions">
          <a href="/ejercicios/editar/${ejercicio.id}" class="btn-small btn-secondary-small">Editar</a>
          <button onclick="eliminarEjercicio(${ejercicio.id})" class="btn-small btn-danger-small">Eliminar</button>
        </div>
      `;

      contenedor.appendChild(card);
    });
  } catch (error) {
    console.error('Error cargando ejercicios:', error);
    contenedor.innerHTML = '<p class="error-text">Error al cargar ejercicios. Intenta recargar la página.</p>';
  }
}

async function eliminarEjercicio(id) {
  if (!confirm('¿Estás seguro de que quieres eliminar este ejercicio? Esta acción no se puede deshacer.')) {
    return;
  }

  const card = document.querySelector(`.card-ejercicio[data-id="${id}"]`);
  if (card) {
    card.style.opacity = '0.6'; 
  }

  try {
    const response = await fetch(`${API_URL}/${id}`, {
      method: 'DELETE'
    });

    const result = await response.json().catch(() => ({}));

    if (response.ok || response.status === 404) {
      if (card) {
        card.remove();
      }
      mostrarMensajeFeedback('¡Ejercicio eliminado con éxito!', 'success');

      if (document.querySelectorAll('.card-ejercicio').length === 0) {
        document.getElementById('lista-ejercicios').innerHTML = `
          <div class="empty-message">
            <p>Aún no tienes ejercicios guardados.</p>
            <a href="/ejercicios/nuevo" class="btn-primary-large">Añade tu primera técnica</a>
          </div>`;
      }
    } else {
      mostrarMensajeFeedback(result.error || 'Error al eliminar el ejercicio', 'error');
      if (card) card.style.opacity = '1';
    }
  } catch (err) {
    console.error('Error de conexión:', err);
    mostrarMensajeFeedback('Posiblemente eliminado. Recargando...', 'success');
    setTimeout(() => location.reload(), 1000);
  }
}

function mostrarMensajeFeedback(texto, tipo = 'success') {
  let feedback = document.getElementById('mensaje-feedback-global');
  if (!feedback) {
    feedback = document.createElement('div');
    feedback.id = 'mensaje-feedback-global';
    feedback.style.position = 'fixed';
    feedback.style.top = '20px';
    feedback.style.left = '50%';
    feedback.style.transform = 'translateX(-50%)';
    feedback.style.padding = '16px 32px';
    feedback.style.borderRadius = '50px';
    feedback.style.fontWeight = 'bold';
    feedback.style.fontSize = '17px';
    feedback.style.zIndex = '9999';
    feedback.style.boxShadow = '0 8px 25px rgba(0,0,0,0.5)';
    feedback.style.transition = 'opacity 0.3s ease';
    document.body.appendChild(feedback);
  }

  feedback.textContent = texto;
  feedback.style.backgroundColor = tipo === 'success' ? '#2ecc71' : '#e74c3c';
  feedback.style.color = 'white';
  feedback.style.opacity = '1';

  clearTimeout(feedback.timeout);
  feedback.timeout = setTimeout(() => {
    feedback.style.opacity = '0';
    setTimeout(() => feedback.remove(), 300);
  }, 3000);
}
</script>

<%- include('../partials/footer') %>